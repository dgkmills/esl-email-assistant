<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESL Email Assistant</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff"/>
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .font-thai { font-family: 'Noto Sans Thai', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .output-box { transition: all 0.3s ease-in-out; }
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <main class="max-w-7xl w-full mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-10 border border-slate-200">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-sky-700">ESL Email Assistant</h1>
                <p class="mt-2 text-slate-600 font-thai text-lg">เครื่องมือช่วยปรับปรุงและเขียนอีเมลภาษาอังกฤษ</p>
            </header>

            <!-- Input Form -->
            <div class="w-full space-y-4 mb-8">
                 <div>
                     <label for="deconstruct" class="block text-lg font-semibold text-slate-800 mb-2">Start with your email draft</label>
                     <textarea id="deconstruct" rows="8" placeholder="Write your main ideas or paste a full draft here in English or Thai. The AI will help you improve it." class="w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 text-base"></textarea>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="generate-button" class="w-full inline-flex justify-center items-center rounded-md border border-transparent bg-sky-600 px-6 py-3 text-base font-medium text-white shadow-sm hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2">
                        Generate & Improve
                    </button>
                    <button id="clear-button" class="w-full inline-flex justify-center rounded-md border border-slate-300 bg-white px-6 py-3 text-base font-medium text-slate-700 shadow-sm hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2">
                        Clear
                    </button>
                </div>
            </div>

            <!-- Output Section -->
            <div id="output-container" class="relative">
                <div id="loader" class="hidden absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center z-10 rounded-lg">
                    <div class="flex flex-col items-center">
                        <div class="loader"></div>
                        <p class="mt-4 text-slate-600 font-medium">Generating options...</p>
                    </div>
                </div>
                <div id="output-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Option 1 -->
                    <div id="output-box-1" class="output-box bg-slate-50 rounded-lg p-4 border border-slate-200 flex-col hidden">
                        <!-- Customization Controls -->
                        <div class="space-y-3 mb-4 p-3 bg-white rounded-md border">
                           <h3 class="font-semibold text-slate-800">Customize Option 1</h3>
                           <div>
                                <label for="tone-1" class="text-sm font-medium text-slate-700">Tone</label>
                                <select id="tone-1" class="option-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 text-sm"></select>
                           </div>
                           <div>
                                <label for="opening-1" class="text-sm font-medium text-slate-700">Opening</label>
                                <select id="opening-1" class="option-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 text-sm"></select>
                           </div>
                           <div>
                                <label for="closing-1" class="text-sm font-medium text-slate-700">Closing</label>
                                <select id="closing-1" class="option-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 text-sm"></select>
                           </div>
                        </div>
                        <!-- Email Output -->
                        <textarea id="output-1" class="w-full h-56 text-base bg-white border border-slate-200 rounded-md resize-none focus:ring-1 focus:ring-sky-500 p-2"></textarea>
                         <div class="mt-2 pt-2 flex items-center">
                            <button data-target="output-1" class="copy-button inline-flex items-center rounded-md border border-transparent bg-slate-200 px-3 py-1.5 text-xs font-medium text-slate-800 hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2">Copy</button>
                            <span class="copy-feedback ml-3 text-xs text-green-600 font-medium opacity-0 transition-opacity">Copied!</span>
                        </div>
                    </div>
                    <!-- Option 2 -->
                     <div id="output-box-2" class="output-box bg-slate-50 rounded-lg p-4 border border-slate-200 flex-col hidden">
                        <!-- Customization Controls -->
                        <div class="space-y-3 mb-4 p-3 bg-white rounded-md border">
                           <h3 class="font-semibold text-slate-800">Customize Option 2</h3>
                            <div>
                                <label for="tone-2" class="text-sm font-medium text-slate-700">Tone</label>
                                <select id="tone-2" class="option-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 text-sm"></select>
                           </div>
                           <div>
                                <label for="opening-2" class="text-sm font-medium text-slate-700">Opening</label>
                                <select id="opening-2" class="option-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 text-sm"></select>
                           </div>
                           <div>
                                <label for="closing-2" class="text-sm font-medium text-slate-700">Closing</label>
                                <select id="closing-2" class="option-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 text-sm"></select>
                           </div>
                        </div>
                         <!-- Email Output -->
                        <textarea id="output-2" class="w-full h-56 text-base bg-white border border-slate-200 rounded-md resize-none focus:ring-1 focus:ring-sky-500 p-2"></textarea>
                         <div class="mt-2 pt-2 flex items-center">
                            <button data-target="output-2" class="copy-button inline-flex items-center rounded-md border border-transparent bg-slate-200 px-3 py-1.5 text-xs font-medium text-slate-800 hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2">Copy</button>
                            <span class="copy-feedback ml-3 text-xs text-green-600 font-medium opacity-0 transition-opacity">Copied!</span>
                        </div>
                    </div>
                </div>
                <div id="placeholder" class="text-center py-16 text-slate-500">
                    Your generated email options will appear here...
                </div>
            </div>
        </main>
    </div>

    <script>
        const generateButton = document.getElementById('generate-button');
        const clearButton = document.getElementById('clear-button');
        const loader = document.getElementById('loader');
        const placeholder = document.getElementById('placeholder');
        
        const outputBox1 = document.getElementById('output-box-1');
        const outputBox2 = document.getElementById('output-box-2');

        // Store for API response data to avoid re-fetching
        let apiDataStore = {};

        const generatePrompt = (userInput, toneOverrides = {}) => {
            const tone1 = toneOverrides.tone1 || 'Formal';
            const tone2 = toneOverrides.tone2 || 'Standard';

            return `You are a helpful assistant for non-native English speakers, specifically Thai adults. Analyze the user's email draft or ideas. Then, generate a comprehensive JSON object with two improved email options.
            - Option 1 should have a ${tone1} tone.
            - Option 2 should have a ${tone2} tone.
            For EACH option, provide:
            1. A 'main_body' text.
            2. An array of 3 different 'opening_lines'.
            3. An array of 3 different 'closing_lines'.
            
            Respond in a valid JSON format only, like this: 
            {"option1": {"main_body": "...", "opening_lines": ["...", "...", "..."], "closing_lines": ["...", "...", "..."]}, "option2": {"main_body": "...", "opening_lines": ["...", "...", "..."], "closing_lines": ["...", "...", "..."]}}
            
            The user's input is: "${userInput}"`;
        };

        const callApi = async (isToneChange = false) => {
            const userInput = document.getElementById('deconstruct').value;
            if (!userInput.trim()) {
                alert("Please provide your email ideas in the text box to begin.");
                return;
            }

            loader.classList.remove('hidden');
            placeholder.classList.add('hidden');
            if (!isToneChange) {
                outputBox1.classList.add('hidden');
                outputBox2.classList.add('hidden');
            }
            generateButton.disabled = true;

            const toneOverrides = isToneChange ? {
                tone1: document.getElementById('tone-1').value,
                tone2: document.getElementById('tone-2').value
            } : {};
            const prompt = generatePrompt(userInput, toneOverrides);

            try {
                const response = await fetch('/.netlify/functions/generateEmail', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                apiDataStore = data; // Save the full response
                
                populateControls(1, data.option1, toneOverrides.tone1 || 'Formal');
                populateControls(2, data.option2, toneOverrides.tone2 || 'Standard');
                
                updateEmailText(1);
                updateEmailText(2);

                outputBox1.classList.remove('hidden');
                outputBox1.classList.add('flex');
                outputBox2.classList.remove('hidden');
                outputBox2.classList.add('flex');

            } catch (error) {
                console.error("API call failed:", error);
                placeholder.textContent = `Error: Could not generate email. ${error.message}`;
                placeholder.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
                generateButton.disabled = false;
            }
        };

        const populateControls = (optionNum, data, currentTone) => {
            const tones = ['Formal', 'Standard', 'Friendly'];
            const toneSelect = document.getElementById(`tone-${optionNum}`);
            const openingSelect = document.getElementById(`opening-${optionNum}`);
            const closingSelect = document.getElementById(`closing-${optionNum}`);

            // Populate tones
            toneSelect.innerHTML = tones.map(t => `<option value="${t}" ${t === currentTone ? 'selected' : ''}>${t}</option>`).join('');

            // Populate openings
            openingSelect.innerHTML = data.opening_lines.map(line => `<option value="${line}">${line}</option>`).join('');

            // Populate closings
            closingSelect.innerHTML = data.closing_lines.map(line => `<option value="${line}">${line}</option>`).join('');
        };
        
        const updateEmailText = (optionNum) => {
            const data = apiDataStore[`option${optionNum}`];
            if (!data) return;

            const opening = document.getElementById(`opening-${optionNum}`).value;
            const closing = document.getElementById(`closing-${optionNum}`).value;
            const outputTextarea = document.getElementById(`output-${optionNum}`);
            
            outputTextarea.value = `${opening}\n\n${data.main_body}\n\n${closing}`;
        };

        const handleControlChange = (event) => {
            const targetId = event.target.id;
            if (targetId.startsWith('tone-')) {
                // It's a tone change, so we need a new API call
                callApi(true);
            } else {
                // It's an opening or closing change, just update the text
                const optionNum = targetId.split('-')[1];
                updateEmailText(optionNum);
            }
        };
        
        const copyToClipboard = (event) => {
            const button = event.target;
            const targetId = button.dataset.target;
            const textArea = document.getElementById(targetId);
            const feedbackSpan = button.nextElementSibling;
            
            textArea.select();
            try {
                document.execCommand('copy');
                feedbackSpan.classList.remove('opacity-0');
                setTimeout(() => feedbackSpan.classList.add('opacity-0'), 2000);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
        };

        const clearAllFields = () => {
            document.getElementById('deconstruct').value = '';
            apiDataStore = {};
            outputBox1.classList.add('hidden');
            outputBox2.classList.add('hidden');
            placeholder.textContent = 'Your generated email options will appear here...';
            placeholder.classList.remove('hidden');
        };

        // --- Event Listeners ---
        generateButton.addEventListener('click', () => callApi(false));
        clearButton.addEventListener('click', clearAllFields);
        
        document.querySelectorAll('.copy-button').forEach(button => {
            button.addEventListener('click', copyToClipboard);
        });
        document.querySelectorAll('.option-control').forEach(select => {
            select.addEventListener('change', handleControlChange);
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(reg => console.log('SW registered.')).catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
</body>
</html>

