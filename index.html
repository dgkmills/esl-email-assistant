<!DOCTYPE html>
<html lang="en" class="light"> <!-- Default to light mode -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESL Email Assistant</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff"/>
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-color: #f8fafc;
            --card-bg-color: #ffffff;
            --text-color: #1e293b;
            --text-muted-color: #64748b;
            --border-color: #e2e8f0;
            --control-bg-color: #ffffff;
            --primary-color: #0ea5e9;
        }
        html.dark {
            --bg-color: #0f172a;
            --card-bg-color: #1e293b;
            --text-color: #e2e8f0;
            --text-muted-color: #94a3b8;
            --border-color: #334155;
            --control-bg-color: #334155;
            --primary-color: #38bdf8;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .main-card { background-color: var(--card-bg-color); border-color: var(--border-color); }
        .font-thai { font-family: 'Noto Sans Thai', sans-serif; }
        .text-muted { color: var(--text-muted-color); }
        .loader {
            border: 4px solid rgba(128, 128, 128, 0.2);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 32px; height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom Select Arrow */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }
        html.dark select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23e2e8f0' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }

        /* Custom Toggle Switch */
        .toggle-bg:after {
            content: '';
            @apply absolute top-0.5 left-0.5 bg-white border border-gray-300 rounded-full h-5 w-5 transition shadow-sm;
        }
        input:checked + .toggle-bg:after {
            transform: translateX(100%);
            @apply border-white;
        }
        input:checked + .toggle-bg {
            @apply bg-sky-600;
        }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <main class="max-w-7xl w-full mx-auto bg-white rounded-2xl shadow-lg p-4 md:p-8 border border-slate-200 main-card">
            
            <header class="flex justify-between items-center mb-6">
                <div class="text-left">
                    <h1 class="text-2xl md:text-3xl font-bold text-sky-600 dark:text-sky-400" data-en="ESL Email Assistant" data-th="‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©">ESL Email Assistant</h1>
                    <p class="mt-1 text-muted" data-en="Your AI-powered tool for professional emails." data-th="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">Your AI-powered tool for professional emails.</p>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Toggles -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-medium text-muted">‚òÄÔ∏è</span>
                        <label for="theme-toggle" class="flex items-center cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="theme-toggle" class="sr-only">
                                <div class="block bg-gray-600 w-11 h-6 rounded-full toggle-bg"></div>
                            </div>
                        </label>
                        <span class="text-sm font-medium text-muted">üåô</span>
                    </div>
                     <div class="flex items-center space-x-2">
                        <span class="text-sm font-bold" data-en="EN" data-th="EN">EN</span>
                        <label for="lang-toggle" class="flex items-center cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="lang-toggle" class="sr-only">
                                <div class="block bg-gray-600 w-11 h-6 rounded-full toggle-bg"></div>
                            </div>
                        </label>
                        <span class="text-sm font-bold font-thai" data-en="TH" data-th="‡πÑ‡∏ó‡∏¢">TH</span>
                    </div>
                </div>
            </header>

            <!-- Input Form -->
            <div class="w-full space-y-4 mb-8">
                 <div>
                     <label for="deconstruct" class="block text-lg font-semibold mb-2" data-en="Start with your email draft" data-th="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏£‡πà‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">Start with your email draft</label>
                     <textarea id="deconstruct" rows="8" class="w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 text-base bg-[var(--control-bg-color)] border-[var(--border-color)] placeholder:text-muted" data-en-placeholder="Write your main ideas or paste a full draft here..." data-th-placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≤‡∏á‡∏£‡πà‡∏≤‡∏á‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div>
                        <label for="sender-name" class="block text-sm font-medium text-muted" data-en="Your Name (for signature)" data-th="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô)">Your Name (for signature)</label>
                        <input type="text" id="sender-name" class="mt-1 w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 text-sm bg-[var(--control-bg-color)] border-[var(--border-color)]">
                    </div>
                    <div>
                        <label for="recipient-name" class="block text-sm font-medium text-muted" data-en="Recipient Name (e.g., Mr. Smith)" data-th="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢)">Recipient Name (e.g., Mr. Smith)</label>
                        <input type="text" id="recipient-name" class="mt-1 w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 text-sm bg-[var(--control-bg-color)] border-[var(--border-color)]">
                    </div>
                    <button id="generate-button" class="w-full inline-flex justify-center items-center rounded-md border border-transparent bg-sky-600 px-6 py-3 text-base font-medium text-white shadow-sm hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 self-end">
                        <span data-en="Generate & Improve" data-th="‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á">Generate & Improve</span>
                    </button>
                </div>
            </div>

            <!-- Output Section -->
            <div id="output-container" class="relative">
                <div id="loader" class="hidden absolute inset-0 bg-opacity-80 flex items-center justify-center z-10 rounded-lg">
                    <div class="flex flex-col items-center">
                        <div class="loader"></div>
                        <p class="mt-4 text-muted font-medium" data-en="Generating options..." data-th="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...">Generating options...</p>
                    </div>
                </div>

                <!-- Subject Line Component -->
                <div id="subject-section" class="hidden mb-6">
                    <h3 class="text-lg font-semibold mb-2" data-en="Subject Line" data-th="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á"></h3>
                    <div class="flex items-center gap-4 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg border border-[var(--border-color)]">
                        <select id="subject-select" class="option-control w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 text-sm bg-[var(--control-bg-color)] border-[var(--border-color)]"></select>
                        <button id="copy-subject-button" data-target="subject-select" class="copy-button inline-flex items-center rounded-md bg-slate-200 dark:bg-slate-600 px-4 py-2 text-xs font-medium hover:bg-slate-300 dark:hover:bg-slate-500">
                            <span data-en="Copy" data-th="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å"></span>
                            <span class="copy-feedback ml-2 text-green-600 font-medium opacity-0 transition-opacity">Copied!</span>
                        </button>
                    </div>
                    <p id="subject-explanation" class="text-sm text-sky-700 dark:text-sky-400 mt-1 pl-1"></p>
                </div>

                <div id="output-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Option 1 & 2 will be dynamically generated here -->
                </div>
                <div id="placeholder" class="text-center py-16 text-muted">
                    <span data-en="Your generated email options will appear here..." data-th="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></span>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- State Management ---
        let state = {
            apiData: null,
            language: 'en',
            theme: 'light'
        };

        // --- DOM Elements ---
        const generateButton = document.getElementById('generate-button');
        const loader = document.getElementById('loader');
        const placeholder = document.getElementById('placeholder');
        const outputGrid = document.getElementById('output-grid');
        const subjectSection = document.getElementById('subject-section');
        const themeToggle = document.getElementById('theme-toggle');
        const langToggle = document.getElementById('lang-toggle');
        const deconstructInput = document.getElementById('deconstruct');

        // --- Core Functions ---
        const generatePrompt = () => {
            const userInput = deconstructInput.value;
            const sender = document.getElementById('sender-name').value.trim() || '[Your Name]';
            const recipient = document.getElementById('recipient-name').value.trim();
            
            const targetLang = state.language === 'th' ? 'Thai' : 'English';
            const explanationLang = state.language === 'th' ? 'English' : 'Thai';
            const explanationKey = state.language === 'th' ? 'en_explanation' : 'th_explanation';

            return `You are an expert ESL assistant for Thai professionals. Analyze the user's draft. Create a comprehensive JSON object containing two distinct email options: one formal, one more standard/friendly.
            IMPORTANT: The value of the "text" field for all parts must be in ${targetLang}. The explanation field must always be present and in ${explanationLang}.

            For EACH of the two options, provide arrays of 3 unique options for each of these keys: 'subject_lines', 'greetings', 'opening_lines', 'main_bodies', 'closing_lines', 'sign_offs'.
            Each item in the array must be an object with a "text" field (in ${targetLang}) and an "${explanationKey}" field (in ${explanationLang}).
            For greetings, use the placeholder "${recipient || '[Recipient Name]'}". For sign-offs, include the placeholder "${sender}".

            The final JSON structure MUST be: {"option1":{...}, "option2":{...}}. Do not include any text outside the JSON object.
            User's draft: "${userInput}"`;
        };
        
        const callApi = async () => {
            if (!deconstructInput.value.trim()) {
                alert(state.language === 'en' ? "Please provide your email ideas in the text box to begin." : "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô");
                return;
            }
            loader.classList.remove('hidden');
            placeholder.classList.add('hidden');
            outputGrid.innerHTML = '';
            subjectSection.classList.add('hidden');
            generateButton.disabled = true;

            try {
                const prompt = generatePrompt();
                const response = await fetch('/.netlify/functions/generateEmail', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                if (!response.ok) {
                     const errorText = await response.text();
                    throw new Error(`API error! status: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                state.apiData = data;
                renderUI();

            } catch (error) {
                console.error("API call failed:", error);
                const errorMsg = state.language === 'en' ? `Error: Could not generate email. ${error.message}` : `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏î‡πâ ${error.message}`;
                placeholder.textContent = errorMsg;
                placeholder.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
                generateButton.disabled = false;
            }
        };

        // --- UI Rendering & Updates ---
        const renderUI = () => {
            if (!state.apiData) return;
            
            subjectSection.classList.remove('hidden');
            const subjectSelect = document.getElementById('subject-select');
            const allSubjects = [...(state.apiData.option1.subject_lines || []), ...(state.apiData.option2.subject_lines || [])];
            const uniqueSubjects = Array.from(new Map(allSubjects.map(item => [item.text, item])).values());
            subjectSelect.innerHTML = uniqueSubjects.map(s => `<option value="${s.text}">${s.text}</option>`).join('');
            
            outputGrid.innerHTML = `
                ${createOptionBoxHTML(1, 'Formal', '‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£')}
                ${createOptionBoxHTML(2, 'Standard', '‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô')}
            `;
            
            populateAllControls();
            updateAllExplanations();
            updateEmailText(1);
            updateEmailText(2);

            attachEventListeners();
            updateUIText(); 
        };

        const createOptionBoxHTML = (num, titleEn, titleTh) => `
            <div id="output-box-${num}" class="output-box bg-slate-50 dark:bg-slate-800/50 rounded-lg p-4 border border-[var(--border-color)] flex flex-col">
                <div class="space-y-3 mb-4 p-3 bg-white dark:bg-slate-700 rounded-md border border-[var(--border-color)]">
                    <h3 class="font-semibold" data-en="${titleEn} Option" data-th="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å${titleTh}"></h3>
                    ${createSelectHTML(num, 'greeting', 'Greeting', '‡∏Ñ‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô')}
                    ${createSelectHTML(num, 'opening_line', 'Opening', '‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏õ‡∏¥‡∏î')}
                    ${createSelectHTML(num, 'main_body', 'Main Request', '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å')}
                    ${createSelectHTML(num, 'closing_line', 'Closing', '‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢')}
                    ${createSelectHTML(num, 'sign_off', 'Sign-off', '‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢')}
                </div>
                <textarea id="output-${num}" class="w-full h-64 text-base bg-white dark:bg-slate-900/50 border border-[var(--border-color)] rounded-md resize-none focus:ring-1 focus:ring-sky-500 p-2" readonly></textarea>
                <div class="mt-2 pt-2 flex items-center">
                    <button data-target="output-${num}" class="copy-button inline-flex items-center rounded-md bg-slate-200 dark:bg-slate-600 px-3 py-1.5 text-xs font-medium hover:bg-slate-300 dark:hover:bg-slate-500">
                        <span data-en="Copy Body" data-th="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤"></span>
                        <span class="copy-feedback ml-2 text-green-600 font-medium opacity-0 transition-opacity">Copied!</span>
                    </button>
                </div>
            </div>`;
        
        const createSelectHTML = (num, key, labelEn, labelTh) => `
            <div>
                <label for="${key}-${num}" class="text-sm font-medium text-muted" data-en="${labelEn}" data-th="${labelTh}"></label>
                <select id="${key}-${num}" data-option-num="${num}" data-key="${key}" class="option-control mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 text-sm bg-[var(--control-bg-color)] border-[var(--border-color)]"></select>
                <p id="${key}-explanation-${num}" class="text-sm text-sky-700 dark:text-sky-400 mt-1 pl-1 h-5 ${state.language === 'en' ? 'font-thai' : ''}"></p>
            </div>`;
        
        const getApiKey = (key) => {
            const pluralMap = {
                'main_body': 'main_bodies',
                'greeting': 'greetings',
                'opening_line': 'opening_lines',
                'closing_line': 'closing_lines',
                'sign_off': 'sign_offs',
                'subject_line': 'subject_lines'
            };
            return pluralMap[key] || `${key}s`;
        };

        const populateAllControls = () => {
             document.querySelectorAll('.option-control').forEach(select => {
                if (!select.dataset.optionNum) return;
                const optionNum = select.dataset.optionNum;
                const key = select.dataset.key;
                const apiKey = getApiKey(key);
                const dataArray = state.apiData[`option${optionNum}`]?.[apiKey];
                if (dataArray && Array.isArray(dataArray)) {
                    select.innerHTML = dataArray.map(item => `<option value="${item.text}">${item.text}</option>`).join('');
                }
            });
        };

        const updateEmailText = (optionNum) => {
            const outputTextarea = document.getElementById(`output-${optionNum}`);
            if(!outputTextarea) return;
            const parts = ['greeting', 'opening_line', 'main_body', 'closing_line', 'sign_off'].map(key => {
                const select = document.getElementById(`${key}-${optionNum}`);
                return select ? select.value : '';
            });
            outputTextarea.value = `${parts[0]}\n\n${parts[1]}\n\n${parts[2]}\n\n${parts[3]}\n\n${parts[4]}`;
        };
        
        const updateAllExplanations = () => {
             document.querySelectorAll('.option-control').forEach(select => updateExplanationForSelect(select));
             updateExplanationForSelect(document.getElementById('subject-select'), true);
        };

        const updateExplanationForSelect = (selectElement, isSubject = false) => {
            if (!selectElement || !state.apiData) return;
            const selectedValue = selectElement.value;
            const explanationKey = state.language === 'th' ? 'en_explanation' : 'th_explanation';
            let item;
            
            if (isSubject) {
                const allSubjects = [...(state.apiData.option1.subject_lines || []), ...(state.apiData.option2.subject_lines || [])];
                item = allSubjects.find(s => s.text === selectedValue);
                const explanationEl = document.getElementById('subject-explanation');
                if (explanationEl) explanationEl.textContent = item?.[explanationKey] || '';
            } else {
                const optionNum = selectElement.dataset.optionNum;
                const key = selectElement.dataset.key;
                const apiKey = getApiKey(key);
                const dataArray = state.apiData[`option${optionNum}`]?.[apiKey];
                item = dataArray?.find(d => d.text === selectedValue);
                const explanationEl = document.getElementById(`${key}-explanation-${optionNum}`);
                if (explanationEl) explanationEl.textContent = item?.[explanationKey] || '';
            }
        };

        // --- Event Handlers ---
        const handleControlChange = (event) => {
            const select = event.target;
            if (select.dataset.optionNum) {
                const optionNum = select.dataset.optionNum;
                updateEmailText(optionNum);
            }
            updateExplanationForSelect(select);
        };

        const copyToClipboard = (event) => {
            const button = event.currentTarget;
            const targetId = button.dataset.target;
            const textToCopy = document.getElementById(targetId).value;
            const feedbackSpan = button.querySelector('.copy-feedback');

            navigator.clipboard.writeText(textToCopy).then(() => {
                feedbackSpan.classList.remove('opacity-0');
                setTimeout(() => feedbackSpan.classList.add('opacity-0'), 2000);
            }).catch(err => console.error('Failed to copy:', err));
        };
        
        const toggleTheme = () => {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            document.documentElement.className = state.theme;
            localStorage.setItem('theme', state.theme);
        };

        const toggleLanguage = () => {
            state.language = state.language === 'en' ? 'th' : 'en';
            localStorage.setItem('language', state.language);
            updateUIText();
            if(state.apiData) callApi();
        };

        const updateUIText = () => {
            document.querySelectorAll('[data-en]').forEach(el => {
                el.innerText = el.dataset[state.language] || el.dataset['en'];
            });
             document.querySelectorAll('[data-en-placeholder]').forEach(el => {
                el.placeholder = el.getAttribute(`data-${state.language}-placeholder`) || el.getAttribute('data-en-placeholder');
            });
            document.querySelectorAll('p[id$="-explanation"]').forEach(p => {
                p.classList.toggle('font-thai', state.language === 'en');
            });
        };

        const attachEventListeners = () => {
            document.querySelectorAll('.option-control').forEach(s => s.addEventListener('change', handleControlChange));
            document.querySelectorAll('.copy-button').forEach(b => b.addEventListener('click', copyToClipboard));
        };

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            state.theme = localStorage.getItem('theme') || 'light';
            document.documentElement.className = state.theme;
            themeToggle.checked = state.theme === 'dark';

            state.language = localStorage.getItem('language') || 'en';
            langToggle.checked = state.language === 'th';
            updateUIText();
            
            generateButton.addEventListener('click', callApi);
            themeToggle.addEventListener('change', toggleTheme);
            langToggle.addEventListener('change', toggleLanguage);
            document.getElementById('subject-select').addEventListener('change', () => updateExplanationForSelect(document.getElementById('subject-select'), true));


            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW registration failed:', err));
                });
            }
        });

    </script>
</body>
</html>

