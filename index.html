<!DOCTYPE html>
<html lang="en" class="light"> <!-- Default to light mode -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESL Email Assistant</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff"/>
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-color: #f8fafc;
            --card-bg-color: #ffffff;
            --text-color: #1e293b;
            --text-muted-color: #64748b;
            --border-color: #e2e8f0;
            --control-bg-color: #ffffff;
            --output-bg-color: #ffffff;
            --primary-color: #0ea5e9;
        }
        html.dark {
            --bg-color: #0f172a; /* slate-900 */
            --card-bg-color: #1e293b; /* slate-800 */
            --text-color: #e2e8f0; /* slate-200 */
            --text-muted-color: #94a3b8; /* slate-400 */
            --border-color: #475569; /* slate-600 - Increased contrast */
            --control-bg-color: #334155; /* slate-700 */
            --output-bg-color: #1a2436; /* custom darker slate */
            --primary-color: #38bdf8; /* sky-400 */
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .main-card { background-color: var(--card-bg-color); border-color: var(--border-color); }
        .font-thai { font-family: 'Noto Sans Thai', sans-serif; }
        .text-muted { color: var(--text-muted-color); }
        .loader {
            border: 4px solid rgba(128, 128, 128, 0.2);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 32px; height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom Select Arrow */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }
        html.dark select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23e2e8f0' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }

        /* UPDATED: Custom Toggle Switch CSS - Removed unsupported @apply and using peer-checked for reactivity */
        .toggle-switch:after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            height: 1.25rem; /* 20px */
            width: 1.25rem; /* 20px */
            border-radius: 9999px;
            background-color: white;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease-in-out;
        }
        .peer:checked + .toggle-switch:after {
            transform: translateX(0.9rem); /* Moves the toggle circle */
        }
        
        /* Bilingual text styling */
        .bilingual-button > span { display: block; line-height: 1.2; }
        .bilingual-header > * { display: block; line-height: 1.2; }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <main class="max-w-7xl w-full mx-auto rounded-2xl shadow-lg p-4 md:p-8 border main-card">
            
            <header class="flex justify-between items-center mb-6">
                <!-- MODIFIED: Bilingual header is now static and won't be changed by the language toggle -->
                <div class="text-left bilingual-header">
                    <h1 class="text-2xl md:text-3xl font-bold text-sky-600 dark:text-sky-400">ESL Email Assistant</h1>
                    <span class="font-thai text-xl text-sky-700 dark:text-sky-500">‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</span>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Toggles -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-medium text-muted">‚òÄÔ∏è</span>
                        <label for="theme-toggle" class="flex items-center cursor-pointer">
                            <div class="relative">
                                <!-- UPDATED: Refactored toggle to use peer-checked for compatibility and better styling -->
                                <input type="checkbox" id="theme-toggle" class="sr-only peer">
                                <div class="toggle-switch block w-10 h-6 rounded-full bg-slate-300 dark:bg-slate-700 peer-checked:bg-sky-500 transition"></div>
                            </div>
                        </label>
                        <span class="text-sm font-medium text-muted">üåô</span>
                    </div>
                     <div class="flex items-center space-x-2">
                        <span class="text-sm font-bold">EN</span>
                        <label for="lang-toggle" class="flex items-center cursor-pointer">
                            <div class="relative">
                                <!-- UPDATED: Refactored toggle to use peer-checked for compatibility and better styling -->
                                <input type="checkbox" id="lang-toggle" class="sr-only peer">
                                <div class="toggle-switch block w-10 h-6 rounded-full bg-slate-300 dark:bg-slate-700 peer-checked:bg-sky-500 transition"></div>
                            </div>
                        </label>
                        <span class="text-sm font-bold font-thai">‡πÑ‡∏ó‡∏¢</span>
                    </div>
                </div>
            </header>

            <!-- Input Form -->
            <div class="w-full space-y-4 mb-8">
                 <div>
                     <label for="deconstruct" class="block text-lg font-semibold mb-2" data-en="Start with your email draft" data-th="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏£‡πà‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"></label>
                     <textarea id="deconstruct" rows="8" class="w-full rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500 text-base bg-[var(--control-bg-color)] border-[var(--border-color)] placeholder:text-muted transition-all duration-200" data-en-placeholder="Write your main ideas or paste a full draft here..." data-th-placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≤‡∏á‡∏£‡πà‡∏≤‡∏á‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div>
                        <label for="sender-name" class="block text-sm font-medium text-muted" data-en="Your Name (for signature)" data-th="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô)"></label>
                        <input type="text" id="sender-name" class="mt-1 w-full rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500 text-sm bg-[var(--control-bg-color)] border-[var(--border-color)]">
                    </div>
                    <div>
                        <label for="recipient-name" class="block text-sm font-medium text-muted" data-en="Recipient Name (e.g., Mr. Smith)" data-th="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢)"></label>
                        <input type="text" id="recipient-name" class="mt-1 w-full rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500 text-sm bg-[var(--control-bg-color)] border-[var(--border-color)]">
                    </div>
                    <!-- MODIFIED: Bilingual button is now static -->
                    <button id="generate-button" class="w-full inline-flex justify-center items-center rounded-md border border-transparent bg-sky-600 px-6 py-2 text-base font-medium text-white shadow-sm hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 self-end bilingual-button disabled:opacity-50" disabled>
                        <span class="font-semibold">Generate & Improve</span>
                        <span class="font-thai text-sm">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</span>
                    </button>
                </div>
            </div>

            <!-- Output Section -->
            <div id="output-container" class="relative">
                <div id="loader" class="hidden absolute inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-10 rounded-lg">
                    <div class="flex flex-col items-center bg-[var(--card-bg-color)] p-6 rounded-lg shadow-xl">
                        <div class="loader"></div>
                        <p class="mt-4 text-muted font-medium bilingual-button">
                            <span data-en="Generating options..." data-th="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å..."></span>
                        </p>
                    </div>
                </div>

                <!-- Subject Line Component -->
                <div id="subject-section" class="hidden mb-6">
                    <h3 class="text-lg font-semibold mb-2" data-en="Subject Line" data-th="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á"></h3>
                    <div class="flex items-center gap-4 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg border border-[var(--border-color)]">
                        <select id="subject-select" data-key="subject_lines" class="option-control w-full rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500 text-sm bg-[var(--control-bg-color)] border-[var(--border-color)]"></select>
                        <button id="copy-subject-button" data-target="subject-select" class="copy-button inline-flex items-center rounded-md bg-slate-200 dark:bg-slate-600 dark:text-slate-100 px-4 py-2 text-xs font-medium hover:bg-slate-300 dark:hover:bg-slate-500">
                            <span data-en="Copy" data-th="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å"></span>
                            <span class="copy-feedback ml-2 text-green-600 dark:text-green-400 font-medium opacity-0 transition-opacity">Copied!</span>
                        </button>
                    </div>
                    <p id="subject-explanation" class="text-sm text-sky-700 dark:text-sky-400 mt-1 pl-1"></p>
                </div>

                <div id="output-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Option 1 & 2 will be dynamically generated here -->
                </div>
                <div id="placeholder" class="text-center py-16 text-muted">
                    <span data-en="Your generated email options will appear here..." data-th="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></span>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- State Management ---
        let state = {
            apiData: null,
            language: 'en', // 'en' or 'th'
            theme: 'light'
        };

        // --- DOM Elements ---
        const generateButton = document.getElementById('generate-button');
        const loader = document.getElementById('loader');
        const placeholder = document.getElementById('placeholder');
        const outputGrid = document.getElementById('output-grid');
        const subjectSection = document.getElementById('subject-section');
        const themeToggle = document.getElementById('theme-toggle');
        const langToggle = document.getElementById('lang-toggle');
        const deconstructInput = document.getElementById('deconstruct');

        // --- Core Functions ---
        const generatePrompt = () => {
            const userInput = deconstructInput.value;
            const sender = document.getElementById('sender-name').value.trim() || '[Your Name]';
            const recipient = document.getElementById('recipient-name').value.trim();
            
            // UPDATED: More direct and concise prompt for faster processing and better reliability.
            return `Analyze the user's draft. Generate a JSON object with two main keys: "option1" (formal) and "option2" (standard/friendly).
Each option key must contain arrays of 3 unique choices for the following keys: 'subject_lines', 'greetings', 'opening_lines', 'main_bodies', 'closing_lines', 'sign_offs'.
Each choice in these arrays must be an object with four properties: "en_text", "th_text", "en_explanation", and "th_explanation".
Use placeholder "${recipient || '[Recipient Name]'}" in greetings and "${sender}" in sign-offs.
User's draft: "${userInput}"`;
        };
        
        const callApi = async () => {
            deconstructInput.classList.remove('ring-2', 'ring-red-500'); // Reset validation style
            if (!deconstructInput.value.trim()) {
                // UPDATED: Replaced alert() with a non-blocking visual cue.
                deconstructInput.classList.add('ring-2', 'ring-red-500');
                deconstructInput.focus();
                return;
            }
            loader.classList.remove('hidden');
            placeholder.classList.add('hidden');
            outputGrid.innerHTML = '';
            subjectSection.classList.add('hidden');
            generateButton.disabled = true;

            try {
                const prompt = generatePrompt();
                const response = await fetch('/.netlify/functions/generateEmail', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                if (!response.ok) {
                     const errorData = await response.json();
                    throw new Error(`API error! status: ${response.status} - ${errorData.error || 'Unknown error'}`);
                }
                
                const data = await response.json();
                state.apiData = data;
                renderUI();

            } catch (error) {
                console.error("API call failed:", error);
                const errorMsg = state.language === 'en' ? `Error: Could not generate email. ${error.message}` : `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏î‡πâ ${error.message}`;
                placeholder.innerText = errorMsg;
                placeholder.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
                generateButton.disabled = false;
            }
        };

        // --- UI Rendering & Updates ---
        const renderUI = () => {
            if (!state.apiData) return;
            
            outputGrid.innerHTML = `
                ${createOptionBoxHTML(1, 'Formal', '‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£')}
                ${createOptionBoxHTML(2, 'Standard', '‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô')}
            `;
            
            populateAllControls();
            attachEventListeners();
            updateAllExplanations();
            updateAllEmailTexts();
            updateUIText(); 
        };

        const createOptionBoxHTML = (num, titleEn, titleTh) => {
            // Determine explanation language based on UI language. This provides assistance in the other language.
            const explanationLang = state.language === 'en' ? 'th' : 'en';

            return `
            <div id="output-box-${num}" class="output-box bg-slate-50 dark:bg-slate-800/50 rounded-lg p-4 border border-[var(--border-color)] flex flex-col">
                <div class="space-y-3 mb-4">
                    <h3 class="font-semibold text-lg" data-en="${titleEn} Option" data-th="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å${titleTh}"></h3>
                    ${createSelectHTML(num, 'greeting', 'Greeting', '‡∏Ñ‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô')}
                    ${createSelectHTML(num, 'opening_line', 'Opening', '‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏õ‡∏¥‡∏î')}
                    ${createSelectHTML(num, 'main_body', 'Main Request', '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å')}
                    ${createSelectHTML(num, 'closing_line', 'Closing', '‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢')}
                    ${createSelectHTML(num, 'sign_off', 'Sign-off', '‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢')}
                </div>
                <textarea id="output-${num}" class="w-full h-48 text-base bg-[var(--output-bg-color)] border border-[var(--border-color)] rounded-md resize-none focus:ring-1 focus:ring-sky-500 p-2" readonly></textarea>
                <div class="mt-2 pt-2 border-t border-[var(--border-color)]">
                    <p class="text-sm text-sky-700 dark:text-sky-400 min-h-[4rem] p-1 ${explanationLang === 'th' ? 'font-thai' : ''}" id="explanation-box-${num}"></p>
                </div>
                <div class="mt-auto pt-2 flex items-center">
                    <button data-target="output-${num}" class="copy-button inline-flex items-center rounded-md bg-slate-200 dark:bg-slate-600 dark:text-slate-100 px-3 py-1.5 text-xs font-medium hover:bg-slate-300 dark:hover:bg-slate-500">
                        <span data-en="Copy Body" data-th="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤"></span>
                        <span class="copy-feedback ml-2 text-green-600 dark:text-green-400 font-medium opacity-0 transition-opacity">Copied!</span>
                    </button>
                </div>
            </div>`;
        }
        
        const createSelectHTML = (num, key, labelEn, labelTh) => `
            <div>
                <label for="${key}-${num}" class="text-sm font-medium text-muted" data-en="${labelEn}" data-th="${labelTh}"></label>
                <select id="${key}-${num}" data-option-num="${num}" data-key="${getApiKeyName(key)}" class="option-control mt-1 block w-full rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500 text-sm bg-[var(--control-bg-color)] border-[var(--border-color)]"></select>
            </div>`;
        
        const getApiKeyName = (key) => {
             const pluralMap = { 'greeting': 'greetings', 'opening_line': 'opening_lines', 'main_body': 'main_bodies', 'closing_line': 'closing_lines', 'sign_off': 'sign_offs' };
             return pluralMap[key] || `${key}s`;
        };

        const populateAllControls = () => {
            const textKey = state.language === 'en' ? 'en_text' : 'th_text';
            
            // Populate Subject
            subjectSection.classList.remove('hidden');
            const subjectSelect = document.getElementById('subject-select');
            const allSubjects = [...(state.apiData.option1.subject_lines || []), ...(state.apiData.option2.subject_lines || [])];
            const uniqueSubjects = Array.from(new Map(allSubjects.map(item => [item[textKey], item])).values());
            subjectSelect.innerHTML = uniqueSubjects.map(s => `<option value="${s[textKey]}">${s[textKey]}</option>`).join('');

            // Populate option controls
            document.querySelectorAll('.option-control').forEach(select => {
                if (!select.dataset.optionNum) return;
                const optionNum = select.dataset.optionNum;
                const key = select.dataset.key;
                const dataArray = state.apiData[`option${optionNum}`]?.[key];
                if (dataArray && Array.isArray(dataArray)) {
                    select.innerHTML = dataArray.map(item => `<option value="${item[textKey]}">${item[textKey]}</option>`).join('');
                }
            });
        };
        
        const updateAllEmailTexts = () => { [1, 2].forEach(updateEmailText); };
        
        const updateEmailText = (optionNum) => {
            const outputTextarea = document.getElementById(`output-${optionNum}`);
            if(!outputTextarea) return;
            const keysToCombine = ['greeting', 'opening_line', 'main_body', 'closing_line', 'sign_off'];
            const parts = keysToCombine.map(key => {
                const select = document.querySelector(`#output-box-${optionNum} [data-key="${getApiKeyName(key)}"]`);
                return select ? select.value : '';
            });
            outputTextarea.value = parts.join('\n\n');
        };
        
        const updateAllExplanations = () => {
             document.querySelectorAll('.option-control').forEach(select => handleControlChange({target: select}));
        };

        const getExplanationForItem = (dataArray, selectedValue) => {
            const textKey = state.language === 'en' ? 'en_text' : 'th_text';
            const explanationKey = state.language === 'en' ? 'th_explanation' : 'en_explanation';
            const item = dataArray?.find(d => d[textKey] === selectedValue);
            return item?.[explanationKey] || '';
        }

        // --- Event Handlers ---
        const handleControlChange = (event) => {
            const select = event.target;
            const optionNum = select.dataset.optionNum;
            const key = select.dataset.key; // e.g., 'subject_lines', 'greetings'
            const isSubject = !optionNum;

            if (isSubject) {
                const allSubjects = [...(state.apiData.option1.subject_lines || []), ...(state.apiData.option2.subject_lines || [])];
                const explanation = getExplanationForItem(allSubjects, select.value);
                const explanationEl = document.getElementById('subject-explanation');
                explanationEl.textContent = explanation;
                explanationEl.className = `text-sm text-sky-700 dark:text-sky-400 mt-1 pl-1 ${state.language === 'en' ? 'font-thai' : ''}`;
            } else {
                updateEmailText(optionNum);
                const dataArray = state.apiData[`option${optionNum}`]?.[key];
                const explanation = getExplanationForItem(dataArray, select.value);
                document.getElementById('explanation-box-' + optionNum).textContent = explanation;
            }
        };

        const copyToClipboard = (event) => {
            const button = event.currentTarget;
            const targetId = button.dataset.target;
            const element = document.getElementById(targetId);
            const textToCopy = (element.tagName === 'SELECT') ? element.options[element.selectedIndex].text : element.value;
            
            const feedbackSpan = button.querySelector('.copy-feedback');

            navigator.clipboard.writeText(textToCopy).then(() => {
                feedbackSpan.classList.remove('opacity-0');
                setTimeout(() => feedbackSpan.classList.add('opacity-0'), 2000);
            }).catch(err => console.error('Failed to copy:', err));
        };
        
        const toggleTheme = () => {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            document.documentElement.className = state.theme;
            localStorage.setItem('theme', state.theme);
        };

        const toggleLanguage = () => {
            state.language = state.language === 'en' ? 'th' : 'en';
            localStorage.setItem('language', state.language);
            // Re-render the entire UI with new language data if API data exists
            if (state.apiData) {
                renderUI();
            } else {
                updateUIText();
            }
        };

        const updateUIText = () => {
             document.querySelectorAll('[data-en][data-th]').forEach(el => {
                const text = el.dataset[state.language];
                if (text) el.innerText = text;
            });
            document.querySelectorAll('[data-en-placeholder]').forEach(el => {
                el.placeholder = el.getAttribute(`data-${state.language}-placeholder`) || el.getAttribute('data-en-placeholder');
            });
        };

        const attachEventListeners = () => {
            document.querySelectorAll('.option-control').forEach(s => s.addEventListener('change', handleControlChange));
            document.querySelectorAll('.copy-button').forEach(b => b.addEventListener('click', copyToClipboard));
        };

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            state.theme = localStorage.getItem('theme') || 'light';
            document.documentElement.className = state.theme;
            themeToggle.checked = state.theme === 'dark';

            state.language = localStorage.getItem('language') || 'en';
            langToggle.checked = state.language === 'th';
            updateUIText();
            
            generateButton.addEventListener('click', callApi);
            themeToggle.addEventListener('change', toggleTheme);
            langToggle.addEventListener('change', toggleLanguage);
            
            deconstructInput.addEventListener('input', () => {
                if (deconstructInput.value.trim()) {
                    generateButton.disabled = false;
                    deconstructInput.classList.remove('ring-2', 'ring-red-500');
                } else {
                    generateButton.disabled = true;
                }
            });

            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW registration failed:', err));
                });
            }
        });

    </script>
</body>
</html>


